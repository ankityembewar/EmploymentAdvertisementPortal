"use strict";import F from"./Templating.js";const format=F["format"];import H from"./Globals.js";const{composed,doc,isSafari}=H;import R from"./Renderer/RendererUtilities.js";const distribute=R["distribute"];import RendererRegistry from"./Renderer/RendererRegistry.js";import U from"./Utilities.js";const{addEvent,clamp,css,discardElement,extend,fireEvent,isArray,isNumber,isString,merge,pick,pushUnique,splat,syncTimeout}=U;class Tooltip{constructor(t,e,i){this.allowShared=!0,this.crosshairs=[],this.distance=0,this.isHidden=!0,this.isSticky=!1,this.now={},this.options={},this.outside=!1,this.chart=t,this.init(t,e),this.pointer=i}bodyFormatter(t){return t.map(function(t){const e=t.series.tooltipOptions;return(e[(t.point.formatPrefix||"point")+"Formatter"]||t.point.tooltipFormatter).call(t.point,e[(t.point.formatPrefix||"point")+"Format"]||"")})}cleanSplit(i){this.chart.series.forEach(function(t){const e=t&&t.tt;e&&(!e.isActive||i?t.tt=e.destroy():e.isActive=!1)})}defaultFormatter(t){var e=this.points||splat(this);let i;return(i=(i=[t.tooltipFooterHeaderFormatter(e[0])]).concat(t.bodyFormatter(e))).push(t.tooltipFooterHeaderFormatter(e[0],!0)),i}destroy(){this.label&&(this.label=this.label.destroy()),this.split&&(this.cleanSplit(!0),this.tt&&(this.tt=this.tt.destroy())),this.renderer&&(this.renderer=this.renderer.destroy(),discardElement(this.container)),U.clearTimeout(this.hideTimer),U.clearTimeout(this.tooltipTimeout)}getAnchor(t,o){const{chart:e,pointer:i}=this,s=e.inverted,r=e.plotTop,a=e.plotLeft;let n;if((t=splat(t))[0].series&&t[0].series.yAxis&&!t[0].series.yAxis.options.reversedStacks&&(t=t.slice().reverse()),this.followPointer&&o)void 0===o.chartX&&(o=i.normalize(o)),n=[o.chartX-a,o.chartY-r];else if(t[0].tooltipPos)n=t[0].tooltipPos;else{let e=0,i=0;t.forEach(function(t){t=t.pos(!0);t&&(e+=t[0],i+=t[1])}),e/=t.length,i/=t.length,this.shared&&1<t.length&&o&&(s?e=o.chartX:i=o.chartY),n=[e-a,i-r]}return n.map(Math.round)}getClassName(t,e,i){const o=this.options,s=t.series,r=s.options;return[o.className,"highcharts-label",i&&"highcharts-tooltip-header",e?"highcharts-tooltip-box":"highcharts-tooltip",!i&&"highcharts-color-"+pick(t.colorIndex,s.colorIndex),r&&r.className].filter(isString).join(" ")}getLabel(){const e=this,t=this.chart.styledMode,i=this.options,o=this.split&&this.allowShared;let s=this.container,r=this.chart.renderer;var a;if(this.label&&(a=!this.label.hasClass("highcharts-label"),(!o&&a||o&&!a)&&this.destroy()),!this.label){if(this.outside){const n=this.chart.options.chart.style,l=RendererRegistry.getRendererType();this.container=s=H.doc.createElement("div"),s.className="highcharts-tooltip-container",css(s,{position:"absolute",top:"1px",pointerEvents:"none",zIndex:Math.max(this.options.style.zIndex||0,(n&&n.zIndex||0)+3)}),this.renderer=r=new l(s,0,0,n,void 0,void 0,r.styledMode)}if(o?this.label=r.g("tooltip"):(this.label=r.label("",0,0,i.shape,void 0,void 0,i.useHTML,void 0,"tooltip").attr({padding:i.padding,r:i.borderRadius}),t||this.label.attr({fill:i.backgroundColor,"stroke-width":i.borderWidth||0}).css(i.style).css({pointerEvents:i.style.pointerEvents||(this.shouldStickOnContact()?"auto":"none")})),e.outside){const h=this.label,{xSetter:c,ySetter:d}=h;h.xSetter=function(t){c.call(h,e.distance),s&&(s.style.left=t+"px")},h.ySetter=function(t){d.call(h,e.distance),s&&(s.style.top=t+"px")}}this.label.attr({zIndex:8}).shadow(i.shadow).add()}return s&&!s.parentElement&&H.doc.body.appendChild(s),this.label}getPlayingField(){var{body:t,documentElement:e}=doc,{chart:i,distance:o,outside:s}=this;return{width:s?Math.max(t.scrollWidth,e.scrollWidth,t.offsetWidth,e.offsetWidth,e.clientWidth)-2*o:i.chartWidth,height:s?Math.max(t.scrollHeight,e.scrollHeight,t.offsetHeight,e.offsetHeight,e.clientHeight):i.chartHeight}}getPosition(i,o,t){const{distance:p,chart:s,outside:f,pointer:e}=this,{inverted:r,plotLeft:a,plotTop:n,polar:l}=s,{plotX:h=0,plotY:c=0}=t,u={},g=r&&t.h||0,{height:d,width:m}=this.getPlayingField(),x=e.getChartPosition(),y=t=>t*x.scaleX,b=t=>t*x.scaleY,v=t=>{var e="x"===t;return[t,e?m:d,e?i:o].concat(f?[e?y(i):b(o),e?x.left-p+y(h+a):x.top-p+b(c+n),0,e?m:d]:[e?i:o,e?h+a:c+n,e?a:n,e?a+s.plotWidth:n+s.plotHeight])};let w=v("y"),T=v("x"),k,S=!!t.negative;!l&&s.hoverSeries?.yAxis?.reversed&&(S=!S);const H=!this.followPointer&&pick(t.ttBelow,!l&&!r===S),M=function(t,e,i,o,s,r,a){var n=f?("y"===t?b:y)(p):p,l=(i-o)/2,h=o<s-p,c=s+p+o<e,d=s-n-i+l,s=s+n-l;if(H&&c)u[t]=s;else if(!H&&h)u[t]=d;else if(h)u[t]=Math.min(a-o,d-g<0?d:d-g);else{if(!c)return!1;u[t]=Math.max(r,s+g+i>e?s:s+g)}},X=function(t,e,i,o,s){if(s<p||s>e-p)return!1;u[t]=s<i/2?1:e-o/2<s?e-o-2:s-i/2},C=function(t){[w,T]=[T,w],k=t},F=()=>{!1!==M.apply(0,w)?!1!==X.apply(0,T)||k||(C(!0),F()):k?u.x=u.y=0:(C(!0),F())};return(r&&!l||1<this.len)&&C(),F(),u}hide(e){const i=this;U.clearTimeout(this.hideTimer),e=pick(e,this.options.hideDelay),this.isHidden||(this.hideTimer=syncTimeout(function(){const t=i.getLabel();i.getLabel().animate({opacity:0},{duration:e&&150,complete:()=>{t.hide(),i.container&&i.container.remove()}}),i.isHidden=!0},e))}init(t,e){this.chart=t,this.options=e,this.crosshairs=[],this.now={x:0,y:0},this.isHidden=!0,this.split=e.split&&!t.inverted&&!t.polar,this.shared=e.shared||this.split,this.outside=pick(e.outside,Boolean(t.scrollablePixelsX||t.scrollablePixelsY))}shouldStickOnContact(t){return!(this.followPointer||!this.options.stickOnContact||t&&!this.pointer.inClass(t.target,"highcharts-tooltip"))}move(t,e,i,o){const s=this,r=s.now,a=!1!==s.options.animation&&!s.isHidden&&(1<Math.abs(t-r.x)||1<Math.abs(e-r.y)),n=s.followPointer||1<s.len;extend(r,{x:a?(2*r.x+t)/3:t,y:a?(r.y+e)/2:e,anchorX:n?void 0:a?(2*r.anchorX+i)/3:i,anchorY:n?void 0:a?(r.anchorY+o)/2:o}),s.getLabel().attr(r),s.drawTracker(),a&&(U.clearTimeout(this.tooltipTimeout),this.tooltipTimeout=setTimeout(function(){s&&s.move(t,e,i,o)},32))}refresh(t,o){const s=this,{chart:r,options:a,pointer:n,shared:e}=this,l=splat(t),h=l[0],i=[],c=a.format,d=a.formatter||s.defaultFormatter,p=r.styledMode;let f={};if(a.enabled&&h.series){U.clearTimeout(this.hideTimer),s.allowShared=!(!isArray(t)&&t.series&&t.series.noSharedTooltip),s.followPointer=!s.split&&h.series.tooltipOptions.followPointer;var t=s.getAnchor(t,o),u=t[0],g=t[1];e&&s.allowShared?(n.applyInactiveState(l),l.forEach(function(t){t.setState("hover"),i.push(t.getLabelConfig())}),(f=h.getLabelConfig()).points=i):f=h.getLabelConfig(),this.len=i.length;const x=isString(c)?format(c,f,r):d.call(f,s);var m=h.series;if(this.distance=pick(m.tooltipOptions.distance,16),!1===x)this.hide();else{if(s.split&&s.allowShared)this.renderSplit(x,l);else{let e=u,i=g;if(o&&n.isDirectTouch&&(e=o.chartX-r.plotLeft,i=o.chartY-r.plotTop),!r.polar&&!1!==m.options.clip&&!l.some(t=>n.isDirectTouch||t.series.shouldShowTooltip(e,i)))return void s.hide();{const y=s.getLabel();a.style.width&&!p||y.css({width:(this.outside?this.getPlayingField():r.spacingBox).width+"px"}),y.attr({text:x&&x.join?x.join(""):x}),y.addClass(s.getClassName(h),!0),p||y.attr({stroke:a.borderColor||h.color||m.color||"#666666"}),s.updatePosition({plotX:u,plotY:g,negative:h.negative,ttBelow:h.ttBelow,h:t[2]||0})}}s.isHidden&&s.label&&s.label.attr({opacity:1}).show(),s.isHidden=!1}fireEvent(this,"refresh")}}renderSplit(t,c){const d=this,{chart:e,chart:{chartWidth:i,chartHeight:o,plotHeight:p,plotLeft:f,plotTop:u,scrollablePixelsY:s=0,scrollablePixelsX:r,styledMode:g},distance:m,options:x,options:{positioner:y},pointer:a}=d;var n,{scrollLeft:l=0,scrollTop:h=0}=e.scrollablePlotArea?.scrollingContainer||{};const b=d.outside&&"number"!=typeof r?doc.documentElement.getBoundingClientRect():{left:l,right:l+i,top:h,bottom:h+o},v=d.getLabel(),w=this.renderer||e.renderer,T=Boolean(e.xAxis[0]&&e.xAxis[0].opposite),{left:k,top:S}=a.getChartPosition();let H=u+h,M,X=p-s;function C(t,e,i,o,s=!0){let r,a;return{x:a=i?(r=T?0:X,clamp(t-o/2,b.left,b.right-o-(d.outside?k:0))):(r=e-H,a=s?t-o-m:t+m,clamp(a,s?a:b.left,b.right)),y:r}}let F=(t=isString(t)?[!1,t]:t).slice(0,c.length+1).reduce(function(t,e,i){if(!1!==e&&""!==e){var i=c[i-1]||{isHeader:!0,plotX:c[0].plotX,plotY:p,series:{}},o=i.isHeader;const l=o?d:i.series,h=l.tt=function(t,e,i){let o=t;var{isHeader:t,series:s}=e;if(!o){const r={padding:x.padding,r:x.borderRadius};g||(r.fill=x.backgroundColor,r["stroke-width"]=x.borderWidth??1),o=w.label("",0,0,x[t?"headerShape":"shape"],void 0,void 0,x.useHTML).addClass(d.getClassName(e,!0,t)).attr(r).add(v)}return o.isActive=!0,o.attr({text:i}),g||o.css(x.style).attr({stroke:x.borderColor||e.color||s.color||"#333333"}),o}(l.tt,i,e.toString());var s,e=h.getBBox(),r=e.width+h.strokeWidth(),{anchorX:a,anchorY:n}=(o&&(M=e.height,X+=M,T&&(H-=M)),function(t){const{isHeader:e,plotX:i=0,plotY:o=0,series:s}=t;let r,a;var n;return e?(r=Math.max(f+i,f),a=u+p/2):({xAxis:t,yAxis:n}=s,r=t.pos+clamp(i,-m,t.len+m),s.shouldShowTooltip(0,n.pos-u+o,{ignoreX:!0})&&(a=n.pos+o)),{anchorX:r=clamp(r,b.left-m,b.right+m),anchorY:a}}(i));"number"==typeof n?(e=e.height+1,s=y?y.call(d,r,e,i):C(a,n,o,r),t.push({align:y?0:void 0,anchorX:a,anchorY:n,boxWidth:r,point:i,rank:pick(s.rank,o?1:0),size:e,target:s.y,tt:h,x:s.x})):h.isActive=!1}return t},[]);!y&&F.some(t=>{var e=d["outside"],e=(e?k:0)+t.anchorX;return e<b.left&&e+t.boxWidth<b.right||e<k-b.left+t.boxWidth&&b.right-e>e})&&(F=F.map(t=>{var{x:e,y:i}=C(t.anchorX,t.anchorY,t.point.isHeader,t.boxWidth,!1);return extend(t,{target:i,x:e})})),d.cleanSplit(),distribute(F,X);const P={left:k,right:k},{container:Y,outside:E,renderer:L}=(F.forEach(function(t){var{x:t,boxWidth:e,isHeader:i}=t;i||(d.outside&&k+t<P.left&&(P.left=k+t),!i&&d.outside&&P.left+e>P.right&&(P.right=k+t))}),F.forEach(function(t){var{x:e,anchorX:i,anchorY:o,pos:s,point:{isHeader:r}}=t;const a={visibility:void 0===s?"hidden":"inherit",x:e,y:(s||0)+H,anchorX:i,anchorY:o};d.outside&&e<i&&(0<(s=k-P.left)&&(r||(a.x=e+s,a.anchorX=i+s),r&&(a.x=(P.right-P.left)/2,a.anchorX=i+s))),t.tt.attr(a)}),d);E&&Y&&L&&({width:l,height:h,x:t,y:n}=v.getBBox(),L.setSize(l+t,h+n,!1),Y.style.left=P.left+"px",Y.style.top=S+"px"),isSafari&&v.attr({opacity:1===v.opacity?.999:1})}drawTracker(){var t=this;if(this.shouldStickOnContact()){var e=t.chart;const o=t.label;var i=t.shared?e.hoverPoints:e.hoverPoint;if(o&&i){const s={x:0,y:0,width:0,height:0},r=this.getAnchor(i);i=o.getBBox();r[0]+=e.plotLeft-(o.translateX||0),r[1]+=e.plotTop-(o.translateY||0),s.x=Math.min(0,r[0]),s.y=Math.min(0,r[1]),s.width=r[0]<0?Math.max(Math.abs(r[0]),i.width-r[0]):Math.max(Math.abs(r[0]),i.width),s.height=r[1]<0?Math.max(Math.abs(r[1]),i.height-Math.abs(r[1])):Math.max(Math.abs(r[1]),i.height),t.tracker?t.tracker.attr(s):(t.tracker=o.renderer.rect(s).addClass("highcharts-tracker").add(o),e.styledMode||t.tracker.attr({fill:"rgba(0,0,0,0)"}))}}else t.tracker&&(t.tracker=t.tracker.destroy())}styledModeFormat(t){return t.replace('style="font-size: 0.8em"','class="highcharts-header"').replace(/style="color:{(point|series)\.color}"/g,'class="highcharts-color-{$1.colorIndex} {series.options.className} {point.options.className}"')}tooltipFooterHeaderFormatter(e,t){const i=e.series,o=i.tooltipOptions,s=i.xAxis,r=s&&s.dateTime,a={isFooter:t,labelConfig:e};let n=o.xDateFormat,l=o[t?"footerFormat":"headerFormat"];return fireEvent(this,"headerFormatter",a,function(t){r&&!n&&isNumber(e.key)&&(n=r.getXDateFormat(e.key,o.dateTimeLabelFormats)),r&&n&&(e.point&&e.point.tooltipDateKeys||["key"]).forEach(function(t){l=l.replace("{point."+t+"}","{point."+t+":"+n+"}")}),i.chart.styledMode&&(l=this.styledModeFormat(l)),t.text=format(l,{point:e,series:i},this.chart)}),a.text}update(t){this.destroy(),this.init(this.chart,merge(!0,this.options,t))}updatePosition(t){const{chart:e,container:i,distance:o,options:s,pointer:r,renderer:a}=this,{height:n=0,width:l=0}=this.getLabel(),{left:h,top:c,scaleX:d,scaleY:p}=r.getChartPosition(),f=(s.positioner||this.getPosition).call(this,l,n,t);let u=(t.plotX||0)+e.plotLeft,g=(t.plotY||0)+e.plotTop,m;a&&i&&(s.positioner&&(f.x+=h-o,f.y+=c-o),m=(s.borderWidth||0)+2*o+2,a.setSize(l+m,n+m,!1),1===d&&1===p||(css(i,{transform:`scale(${d}, ${p})`}),u*=d,g*=p),u+=h-f.x,g+=c-f.y),this.move(Math.round(f.x),Math.round(f.y||0),u,g)}}!function(e){e.compose=function(t){pushUnique(composed,"Core.Tooltip")&&addEvent(t,"afterInit",function(){const t=this.chart;t.options.tooltip&&(t.tooltip=new e(t,t.options.tooltip,this))})}}(Tooltip=Tooltip||{});export default Tooltip;